<dialog id="tooltip" class="loading" role="tooltip" aria-labelledby="h-tooltip">
  <h2>
    <a lang="de" href="#" title="Open definition in new tab" target="_blank">
      <dfn id="h-tooltip"></dfn>
      <small lang="en"></small>
    </a>
  </h2>
  <a href="#" title="Close" class="close-button" role="button" aria-label="Close tooltip"><i class="icon close"></i></a>
  <div class="article-body"></div>
</dialog>
{% js %}
  window.addEventListener("DOMContentLoaded", function() {
    const tooltip = document.getElementById('tooltip');

    tooltip.querySelector('.close-button').addEventListener('click', hideTooltip);
    tooltip.addEventListener('click', clickEvent => {
      if(clickEvent.target === tooltip) {
        tooltip.close();
      }
    })

    function showTooltip(clickEvent) {
      // When switching from a tooltip to another, prevent the old content from showing on the new tooltip
      tooltip.querySelector('h2 a dfn').innerHTML = '';
      tooltip.querySelector('.article-body').innerHTML = '<p class="spinner">Loading...</p>';
      tooltip.classList.add('loading');

      // Fetch description
      const anchor = clickEvent.currentTarget || clickEvent.target;
      fetch(anchor.getAttribute('href') + '.json').then(r => r.json()).then(data => {
        tooltip.showModal();
        tooltip.querySelector('h2 a').setAttribute('href', anchor.getAttribute('href'));
        tooltip.querySelector('h2 a dfn').innerHTML = data.title;
        tooltip.querySelector('h2 a small').innerHTML = data.englishTerm || '';
        tooltip.querySelector('h2 a small').classList.toggle('hidden', !data.englishTerm);
        tooltip.querySelector('.article-body').innerHTML = data.definition;
        tooltip.querySelector('.article-body').querySelectorAll('a').forEach(a => a.target = '_blank');

        tooltip.querySelector('.article-body').querySelector('#footnotes').remove();
        tooltip.classList.remove('loading');
        plausible('Glossary tooltip', { props: { url: anchor.getAttribute('href') }});
      });
    }

    function hideTooltip(event) {
      event.preventDefault();
      tooltip.close();
    }

    document.querySelectorAll('.article-body a[href*="/glossary/"]').forEach((anchor) => {
      if(typeof tooltip.show === 'function') {
        anchor.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          showTooltip(event);
        });
      }
      else {
        anchor.setAttribute('target', '_blank');
      }
    });
  });
{% endjs %}