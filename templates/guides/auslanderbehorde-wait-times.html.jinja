{% extends "guides/entry.html.jinja" %}

{% block postHead %}
    {{ super() }}
    <link rel="preload" as="fetch" href="/api/forms/residence-permit-feedback.json?page=1" crossorigin>
{% endblock %}

{% include '_js/utils.js' %}
{% include '_js/vue.js' %}
{% include '_js/vue/feedback-residence-permit.js' %}
{% include '_js/vue/mixins/residencePermitFeedbackMixin.js' %}
{% js %}
	document.querySelectorAll('main .article-body').forEach(
		el => new Vue({
			el: el,
			mixins: [residencePermitFeedbackMixin],
			data() {
				return {
					isLoading: true,
					resultPages: [], // An array of arrays. First a list of pages, then items on that page
					page: null,
					resultCount: 0,
					itemsPerPage: 10,
					stats: {
						response: {
							waitTime: 'Loading…',
							count: 'many',
						},
						appointment: {
							waitTime: 'Loading…',
						},
						pickup: {
							waitTime: 'Loading…',
						},
						total: {
							waitTime: 'this long',
						}
					}
				};
			},
			async mounted(){
				this.loadPage(1, false);
			},
			computed: {
				apiEndpoint(){
					const querystring = new URLSearchParams({ page: this.page });
					if(this.residencePermitType){
						querystring.append('residence_permit_type', this.residencePermitType);
					}
					if(this.department){
						querystring.append('department', this.department);
					}
					return '/api/forms/residence-permit-feedback.json?' + querystring.toString();
				},
				pageCount(){
					return Math.ceil(this.resultCount / this.itemsPerPage);
				},
				pageNumbers(){
					return Array.from({length: this.pageCount}, (_, i) => i + 1);
				},
				resultsPage(){
					return this.isLoading ? [] : this.resultPages[this.page];
				},
				residencePermitName(){
					return this.residencePermitTypes[this.residencePermitType] || {
						normal: "residence permit",
						capitalized: "Residence permit"
					}
				},
				supportLink(){
					return {
						BLUE_CARD: '/guides/blue-card',
						WORK_VISA: '/guides/work-visa',
						FREELANCE_VISA: '/guides/freelance-visa',
						PERMANENT_RESIDENCE: '/guides/permanent-residence',
					}[this.residencePermitType] || null;
				}
			},
			methods: {
				async loadPage(page, scrollToTop=true){
					this.page = page;
					if(scrollToTop){
						Vue.nextTick(() => {
							this.$el.querySelector('#feedback-from-other-people').scrollIntoView(true);
						});
					}

					if(!this.resultPages[page]){
						this.isLoading = true;
						response = await (await fetch(this.apiEndpoint)).json();
						this.resultCount = response.count;
						this.resultPages[page] = response.results.map(r => {
							r.modification_date = new Date(r.modification_date);
							r.application_date = new Date(r.application_date);
							r.first_response_date = r.first_response_date ? new Date(r.first_response_date) : null;
							r.appointment_date = r.appointment_date ? new Date(r.appointment_date) : null;
							r.pick_up_date = r.pick_up_date ? new Date(r.pick_up_date) : null;
							return r;
						});

						const unknown = 'for an unknown duration';

						this.stats.response.waitTime = `Wait ${response.stats.first_response_date.readable_range ?? unknown}`;
						this.stats.appointment.waitTime = `Wait ${response.stats.appointment_date.readable_range ?? unknown}`;
						this.stats.pickup.waitTime = `Wait ${response.stats.pick_up_date.readable_range ?? unknown}`;
						this.stats.total.waitTime = response.stats.total.readable_range ?? 'an unknown time';
						console.log(response.stats)
						this.stats.response.count = response.stats.first_response_date.count ?? this.stats.response.count;

						this.isLoading = false;
					}
				},
				async deleteResult(modificationKey){
					if(confirm('Delete this item?')){
						await fetch(
							`/api/forms/residence-permit-feedback/${modificationKey}`, {
								method: 'DELETE',
								keepalive: true,
								headers: {'Content-Type': 'application/json; charset=utf-8'}
							}
						);
						this.resultPages.splice(0, this.resultPages.length);
						this.loadPage(this.page);
					}
				},
				formatTimeDelta(date1, date2){
					const millisecondsPerDay = 1000 * 60 * 60 * 24;
					const days = Math.ceil((date2.getTime() - date1.getTime()) / millisecondsPerDay);
					let qty, unit = null;
					if(days <= 7 * 2){
						qty = days
						unit = (qty === 1 ? 'day' : 'days');
					}
					else if(days <= 7 * 8){
						qty = Math.round(days / 7);
						unit = (qty === 1 ? 'week' : 'weeks');
					}
					else{
						qty = Math.round(days / 30)
						unit = (qty === 1 ? 'month' : 'months');
					}

					return `${qty} ${unit}`;
				},
				waitTime(date1, date2, stillWaiting=false) {
					if(stillWaiting){
						const timeDelta = this.formatTimeDelta(date1, date2);
						return timeDelta.startsWith('1 ') ? `${timeDelta} has passed` : `${timeDelta} have passed`;
					}
					else if(date2 > date1){
						return `Waited ${this.formatTimeDelta(date1, date2)}`
					}
					return `Waiting ${this.formatTimeDelta(date1, date2)}`;
				},
			},
			watch: {
				department(){
					this.resultPages = [];
					this.loadPage(1, false);
				},
				residencePermitType(){
					this.resultPages = [];
					this.loadPage(1, false);
					this.$el.querySelector('#residence-permit-wait-times').innerHTML = `${this.residencePermitName.capitalized} wait times`;
				},
			}
		})
	);
{% endjs %}