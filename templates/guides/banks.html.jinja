{% extends "guides/entry.html.jinja" %}
{% set entry = entries['guides/first-bank-account-in-germany.md'] %} 

{% block main %}
	<main aria-label="Main page">
		<article class="section">
			<h1>{{ entry.title }}</h1>
			{% include "_blocks/postMeta.html" %}
			{% with entry=entry, showRelatedEntriesLink=related_collections|length %}
				{% raw %}
				<div class="article-body">
					<div class="bank-comparator" v-cloak>
						<div class="filters no-print">
							<div class="tags">
								<button @click="showAllTags=!showAllTags" class="primary"><i class="icon filter"></i> {{ showAllTags ? 'Hide filters' : 'Filter banks' }}</button>
								<tag :tag="t" v-for="t in tags" v-if="t.selected" :key="t.name"></tag>
								<tag icon="add" :tag="t" v-for="t in suggestedTags" :key="t.name"></tag>
							</div>
							<template v-if="showAllTags">
								<div class="form-group">
									<span class="label">Bank language</span>
									<div class="input-group tags">
										<tag :tag="t" v-for="t in tagGroups.languages.tags" :key="t.name"></tag>
									</div>
								</div>
								<div class="form-group">
									<span class="label">Features</span>
									<tag-checkbox :tag="t" v-for="t in tagGroups.features.tags" :key="t.name"></tag-checkbox>
								</div>
								<div class="form-group">
									<span class="label">Payment methods</span>
									<tag-checkbox :tag="t" v-for="t in tagGroups.paymentMethods.tags" :key="t.name"></tag-checkbox>
								</div>
								<div class="form-group">
									<span class="label">Bank requirements</span>
									<tag-checkbox :tag="t" v-for="t in tagGroups.requirements.tags" :key="t.name"></tag-checkbox>
								</div>
								<hr>
								<div class="form-group">
									<label :for="uid('nationality')">Nationality</label>
									<select :id="uid('nationality')" v-model="nationality">
										<option value="" disabled selected hidden>Choose a country</option>
										<option value="">Unknown</option>
										<option disabled>──────────</option>
										<option v-for="country in sortedCountryList" :key="country[0]" :value="country[0]">{{ country[1] }}</option>
									</select>
									<span class="input-instructions">
										It's harder to open a bank account with certain passports.
									</span>
								</div>
								<div class="form-group show-errors">
									<label :for="uid('income')">
										Income
									</label>
									<div class="input-group">
										<income-input :id="uid('income')" v-model="income"></income-input>
										€ per month
									</div>
								</div>
								<hr>
							</template>
						</div>
						<ul class="bank-options">
							<li class="account" :class="{hidden: account.score < 0}" v-for="account in sortedAccounts" :key="account.bank.name + account.name">
								<a class="logo" :href="account.url" target="_blank">
									<img :src="logo(account.bank)">
								</a>
								<h3>
									<a :href="account.url" target="_blank">{{ account.bank.name }} {{ account.name }}</a>
								</h3>
								<p v-if="account.description" v-html="account.description" class="description"></p>
								<div class="actions">
									<a v-if="!account.hidden && !account.saved" @click="account.saved = !account.saved">{% endraw %}{% include '_css/icons/star.svg' %}{% raw %} Save</a>
									<a v-if="!account.hidden && account.saved" @click="account.saved = !account.saved">{% endraw %}{% include '_css/icons/star-filled.svg' %}{% raw %} Saved</a>
									<a v-if="!account.saved" @click="account.hidden = !account.hidden">{{ account.hidden ? 'Unhide' : 'Hide' }}</a>
								</div>
								<div class="details">
									<div class="features">
										<h4>Features</h4>
										<div class="price" :class="{error: hasTagError(account, 'Girocard')}">
											<glossary term="Girocard">Girocard / EC-Karte</glossary>
											<output>{{ hasTag(account, 'Girocard') }}</output>
										</div>
										<div class="price" :class="{error: hasTagError(account, 'Apple Pay / Google Pay')}">
											Apple Pay / Google Pay
											<output>{{ hasTag(account, 'Apple Pay / Google Pay') }}</output>
										</div>
										<div class="price" :class="{error: hasTagError(account, 'Visa')}">
											Visa
											<output>{{ hasTag(account, 'Visa') }}</output>
										</div>
										<div class="price" :class="{error: hasTagError(account, 'Mastercard')}">
											Mastercard
											<output>{{ hasTag(account, 'Mastercard') }}</output>
										</div>
									</div>
									<div class="costs">
										<h4>Costs</h4>
										<details>
											<summary class="price">
												Monthly fee
												<output><eur :amount="account.monthlyFee"></eur></output>
											</summary>
										</details>
										<details>
											<summary class="price">
												Card fee
												<output v-if="account.creditCardOneTimeFee">one time {{ formatCurrency(account.creditCardOneTimeFee) }}</output>
												<output v-if="!account.creditCardOneTimeFee"><eur :amount="account.creditCardMonthlyFee"></eur></output>
											</summary>
											<p v-html="account.creditCardFeeExplanation"></p>
										</details>
										<details>
											<summary class="price">
												Withdrawal fee
												<output><eur :amount="account.atmFee"></eur></output>
											</summary>
											<p v-html="account.atmFeeExplanation"></p>
										</details>
										<details>
											<summary class="price">
												Interest rate
												<output>5%</output>
											</summary>
											<p>Every year, you earn 5% interest on the money in your bank account.</p>
										</details>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
				{% endraw %}
			{% endwith %}
		</article>
	</main>

	<div class="sidebar no-print" aria-hidden="true">
		{% with entry=entry, showScrollToTop=true, showSupportLink=true, showRelatedEntriesLink=related_collections|length %}
			{% include '_blocks/tableOfContents.html' %}
		{% endwith %}
	</div>
	{% include "_js/sidebar.js" %}
{% endblock %}

{% include '_js/countries.js' %}
{% include '_js/currency.js' %}
{% include '_js/vue.js' %}
{% include '_js/vue/eur.js' %}
{% include '_js/vue/glossary.js' %}
{% include '_js/vue/income-input.js' %}
{% include '_js/vue/uniqueIdsMixin.js' %}

{% js %}{% raw %}

const banks = [
	{
		boost: 0,
		name: 'Commerzbank',
		tags: [
			'English',
			'Girocard',
			'Apple Pay / Google Pay',
		],
		url: '/out/commerzbank',
		accounts: [
			{
				name: 'Basic',
				description: "A simple account with a simple bank",
				atmFee: 99,
				atmFeeExplanation: 'Free withdrawals from Cash Group ATMs.',
				creditCardMonthlyFee: 3.9,
				creditCardFeeExplanation: 'Free virtual card for online shopping. 3.90 € for a plastic card.',
				monthlyFee: 0,
				tags: [],
			},
			{
				name: 'Klassik',
				description: null,
				atmFee: 99,
				atmFeeExplanation: 'Free withdrawals from Cash Group ATMs.',
				creditCardMonthlyFee: 0,
				monthlyFee: 6.9,
				tags: ['Mastercard'],
			},
		]
	},
	{
		boost: 2,
		name: 'N26',
		tags: [
			'English',
			'French',
			'Spanish',
			'Italian',
			'No Anmeldung',
			'No ATM fee',
		],
		url: '/out/n26-plans',
		accounts: [
			{
				name: 'Standard',
				description: null,
				atmFee: 0,
				atmFeeExplanation: '3 free withdrawals per month, then 2 € per withdrawal. You can use any ATM.',
				creditCardOneTimeFee: 10,
				creditCardMonthlyFee: 0,
				creditCardFeeExplanation: 'Free virtual card for online shopping. 10 € to get a plastic card.',
				monthlyFee: 0,
				tags: [],
			},
			{
				name: 'Smart',
				description: "Comes with travel insurance and free donuts.",
				atmFee: 0,
				atmFeeExplanation: '5 free withdrawals per month, then 2 € per withdrawal. You can use any ATM.',
				creditCardMonthlyFee: 0,
				monthlyFee: 4.9,
				tags: [],
			},
			{
				name: 'You',
				description: null,
				atmFee: 0,
				atmFeeExplanation: '5 free withdrawals per month, then 2 € per withdrawal. You can use any ATM.',
				creditCardMonthlyFee: 0,
				monthlyFee: 9.9,
				tags: [],
			},
			{
				name: 'Metal',
				description: null,
				atmFee: 0,
				atmFeeExplanation: '8 free withdrawals per month, then 2 € per withdrawal. You can use any ATM.',
				creditCardMonthlyFee: 0,
				monthlyFee: 16.9,
				tags: [],
			},
		],
	},
];

const tags = {
	'English': {
		error: 'No English',
		description: 'English-speaking bank',
		group: 'languages',
		default: true,
	},
	'French': {
		error: 'No French',
		description: 'French-speaking bank',
		group: 'languages',
	},
	'Italian': {
		error: 'No Italian',
		description: 'Italian-speaking bank',
		group: 'languages',
	},
	'Spanish': {
		error: 'No Spanish',
		description: 'Spanish-speaking bank',
		group: 'languages',
	},
	'Apple Pay / Google Pay': {
		error: 'No Apple Pay / Google Pay',
		description: 'Pay with your iPhone or Android phone',
		group: 'paymentMethods',
	},
	'Girocard': {
		error: 'No Girocard',
		description: 'A common payment method in Germany',
		group: 'paymentMethods',
	},
	'Visa': {
		error: 'No Visa',
		group: 'paymentMethods',
	},
	'Mastercard': {
		error: 'No Mastercard',
		group: 'paymentMethods',
	},
	'No Anmeldung': {
		error: 'Anmeldung needed',
		description: 'Open an account without registering your address.',
		group: 'requirements',
		default: true,
	},
	'No residence permit': {
		error: 'Residence permit needed',
		description: 'Open an account without a residence permit.',
		group: 'requirements',
	},
	'No monthly fee': {
		group: 'features',
		error: 'Monthly fee',
		default: true,
	},
	'No ATM fee': {
		group: 'features',
		description: 'Get cash from any ATM without fees.',
		error: 'ATM fee',
		default: true,
	},
	'Physical branches': {
		group: 'features',
		description: 'Go to the bank in person.',
		error: 'No physical branches',
	},
	'Blocking account': {
		group: 'features',
		description: 'Required for student, job seeker and language course visas.',
		error: 'No blocking account',
	},
};

const tagGroups = {
	features: {
		order: 1,
	},
	paymentMethods: {
		order: 2,
	},
	languages: {
		order: 3,
	},
	requirements: {
		order: 4,
	},
};

Object.entries(tags).forEach(([name, tag]) => {
	tag.name = name;
	tag.default = tag.default || false;
	tag.selected = tag.selected || false;
	tag.group = tagGroups[tag.group];
});

Object.entries(tagGroups).forEach(([name, tagGroup]) => {
	tagGroup.tags = Object.values(tags).filter(t => t.group === tagGroup);
});

const accounts = banks.reduce((allAccounts, bank) => {
	return bank.accounts.reduce((allAccounts, account) => {
		account.bank = bank;
		account.url = account.url || bank.url;

		// Combine bank and account tags
		account.tags.push(...bank.tags);

		// Replace tag names with tag objects
		account.tags = account.tags.map(t => tags[t]);

		// Set UI attributes
		account.saved = false;
		account.hidden = false;

		allAccounts.push(account);
		return allAccounts;
	}, allAccounts);
}, []);

Vue.component('tag', {
	props: {
		icon: String,
		tag: Object,
		error: Boolean,
	},
	template: `
	<button :title="error ? '' : (tag.description || '')" :class="{active: tag.selected, error: error}" @click="tag.selected = !tag.selected">
		<i class="icon" :class="icon" v-if="icon"></i>
		{{ error ? (tag.error || tag.name) : tag.name }}
	</button>`,
});
Vue.component('tag-checkbox', {
	props: {
		tag: Object,
	},
	template: `
	<label class="checkbox">
		<input type="checkbox" v-model="tag.selected">
		<div>
			{{ tag.name }}
			<br v-if="tag.description">
			<small v-if="tag.description">{{ tag.description }}</small>
		</div>
	</label>`,
});

document.querySelectorAll('.bank-comparator').forEach(el => new Vue({
	el: el,
	mixins: [uniqueIdsMixin],
	data() {
		return {
			banks,
			accounts,
			tags,
			tagGroups,
			showAllTags: false,
			nationality: '',
			income: 0,
			sortedCountryList: countries.getSortedList(),
			formatCurrency,
		};
	},
	computed: {
		// Flatten the list of banks into a list of accounts
		sortedAccounts(){
			return this.accounts.map((account) => {
				account.missingTags = this.selectedTags.filter(t => !account.tags.includes(t));
				account.tags = account.tags.sort((t1, t2) => {
					if(t1.selected !== t2.selected) {
						return t2.selected > t1.selected;
					}
					return t1.group.order > t2.group.order;
				});

				account.score = (
					account.missingTags.length * -10
					+ account.tags.filter(t => t.selected).length * 10
					+ account.bank.boost
					+ 1
				);
				return account;
			}).sort((a, b) => {
				if(a.saved !== b.saved) {
					return a.saved < b.saved;
				}
				if(a.hidden !== b.hidden) {
					return a.hidden > b.hidden;
				}
				return b.score - a.score;
			});
		},
		selectedTags(){
			return Object.values(tags).filter(t => t.selected);
		},
		suggestedTags(){
			const defaultTags = Object.values(tags).filter(t => t.default);
			return defaultTags
				.filter(f => !f.selected)
				.slice(
					0, Math.max(defaultTags.length - this.selectedTags.length, 0)
				);
		},
	},
	methods: {
		logo(bank){
			return `/staticimages/banks/${bank.name.toLowerCase()}.png`;
		},
		hasTag(account, tagName){
			return account.tags.includes(this.tags[tagName]) ? "Yes" : "No";
		},
		hasTagError(account, tagName){
			return this.tags[tagName].selected && !account.tags.includes(this.tags[tagName]);
		},
	}
}));
{% endraw %}{% endjs %}