{% extends "_layout.html" %}
{% set metatitle = "Calculator test" %}
{% set metadescription = "" %}

{% block postHead %}
	{{ super() }}
	<meta name="robots" content="noindex">
{% endblock %}

{% block content %}
	<h1>Tool test</h1>
	<div class="article-body">

<script src="/js/pdflib.js"></script>
<collapsible class="anmeldung-form" {% if static|default %}static{% endif %}>
{% raw %}
	<template v-slot:header>Anmeldung form helper</template>
	<template v-if="stage === 'start'">
		<h2>Your new address</h2>
		<p>Where are you moving? Enter the address that you want to register.</p>
		<hr>
		<div class="form-group">
			<label :for="uid('newAddress')">Street address</label>
			<input
				:id="uid('newAddress')"
				class="street-input"
				type="text"
				v-model="newAddress"
				placeholder="Neue Straße 123A"
				autocomplete="address-line2">
		</div>
		<div class="form-group">
			<label :for="uid('city')">Building details</label>
			<input
				class="city-input"
				type="text"
				v-model="newBuildingDetails"
				placeholder="Haus B, 2. Etage rechts"
				autocomplete="address-line2">
			<details class="input-instructions">
				<summary>Give your building, floor and apartment number</summary>
				<p>The <em><glossary>Bürgeramt</glossary></em> often asks for this information during your <em>Anmeldung</em> appointment.</p>
				<p><a href="/guides/addressing-a-letter-in-germany#extra-information" target="_blank">How to write this information ➞</a></p>
			</details>
		</div>
		<div class="form-group">
			<label :for="uid('postCode')"><glossary term="Postleitzahl">Post code</glossary> and city</label>
			<div class="input-group">
				<input
					:id="uid('postCode')"
					class="postalcode-input"
					v-model="newPostCode"
					placeholder="12345"
					type="text"
					inputmode="numeric"
					pattern="[0-9]{5}"
					minlength="5"
					maxlength="5"
					autocomplete="postal-code">
				<input
					class="city-input"
					type="text"
					v-model="newCity"
					placeholder="Berlin"
					autocomplete="address-level2">
			</div>
		</div>
		<hr>
		<div class="form-group">
			<label>Move-in date</label>
			<date-picker v-model="moveInDate"></date-picker>
			<span class="input-instructions">Use the same date as on your <glossary>Wohnungsgeberbestätigung</glossary>.</span>
		</div>
	</template>
	<template v-if="stage === 'oldAddress'">
		<h2>Your old address</h2>
		<p>Where did you live before? You can replace your old address, or have multiple registered addresses.</p>
		<hr>
		<div class="form-group">
			<label :for="uid('oldCountry')">Country</label>
			<div class="input-group">
				<select v-model="oldCountry" :id="uid('oldCountry')" autocomplete="country-name">
					<option disabled hidden default value="">Country of your previous address</option>
					<option>Germany</option>
					<option disabled>──────────</option>
					<option v-for="country in sortedCountryList" :key="country[0]">{{ country[1] }}</option>
				</select>
				<span class="input-instructions" v-if="oldCountry && oldCountry !== 'Germany'">That's enough information for the <em><glossary>Bürgeramt</glossary></em>.</span>
			</div>
		</div>
		<template v-if="oldCountry === 'Germany'">
			<div class="form-group">
				<label :for="uid('oldAddress')">Street address</label>
				<input
					:id="uid('oldAddress')"
					class="street-input"
					type="text"
					v-model="oldAddress"
					placeholder="Alte Straße 12"
					autocomplete="address-line2">
			</div>
			<div class="form-group">
				<label :for="uid('city')">Building details</label>
				<input
					class="city-input"
					type="text"
					v-model="oldCity"
					placeholder="Haus B, 2. Etage rechts"
					autocomplete="address-line2">
			</div>
			<div class="form-group">
				<label :for="uid('oldPostCode')"><glossary term="Postleitzahl">Post code</glossary> and city</label>
				<div class="input-group">
					<input
						:id="uid('oldPostCode')"
						class="postalcode-input"
						v-model="oldPostCode"
						placeholder="12345"
						type="text"
						inputmode="numeric"
						pattern="[0-9]{5}"
						minlength="5"
						maxlength="5"
						autocomplete="postal-code">
					<input
						class="city-input"
						type="text"
						v-model="oldCity"
						placeholder="Berlin"
						autocomplete="address-level2">
				</div>
			</div>
		</template>
	</template>
	<template v-if="stage === 'addPeople'">
		<h2>Who is registering?</h2>
		<p>You can register multiple people at the same time if you live together before and after the move.</p>
		<template v-for="(person, index) in people">
			<hr>
			<div class="form-group" v-if="person.showExtraFields">
				<label>Title</label>
				<input type="text"
					v-model="person.title"
					placeholder="Dr. Prof." 
					class="anrede-input">
			</div>
			<div class="form-group">
				<label :for="uid('firstName')">First and last name</label>
				<div class="input-group">
					<input type="text"
						:id="uid('firstName')"
						v-model="person.firstName"
						placeholder="Alex"
						autocomplete="given-name"
						class="first-name-input">
					<input type="text"
						v-model="person.lastName"
						placeholder="Anderplatz"
						autocomplete="family-name"
						class="last-name-input">
					<a href="#" v-if="!person.showExtraFields" @click.prevent="person.showExtraFields = true">Add title, birth name or artist name</a>
				</div>
			</div>
			<div class="form-group" v-if="person.showExtraFields">
				<label>Name at birth</label>
				<input type="text" v-model="person.birthName" placeholder="Alex Térieur">
			</div>
			<div class="form-group" v-if="person.showExtraFields">
				<label>Artist name</label>
				<input type="text" v-model="person.artistName" placeholder="DJ Berolina">
			</div>
			<div class="form-group">
				<label>Date of birth</label>
				<div class="input-group">
					<date-picker
					  v-model="person.dateOfBirth"
					  autocomplete="bday"></date-picker>
				</div>
			</div>
			<div class="form-group">
				<label>Place of birth</label>
				<input type="text" placeholder="Berlin, Germany">
			</div>
			<div class="form-group">
				<label>
					Nationality
				</label>
				<input type="text"
				  placeholder="Canada"
				  :list="uid('countries')"
				  v-model="person.nationality">
			</div>
			<div class="form-group">
				<label>
					Religion
				</label>
				<div class="input-group">
					<select v-model="person.religion">
						<option value="Evangelische Kirche">Evangelical Church</option>
						<option value="Römisch-katholische Kirche">Roman Catholic Church</option>
						<option value="Jüdische Gemeinde">Jewish Community</option>
						<option value="Altkatholische Kirche">Old Catholic Church</option>
						<option value="Freireligiöse Gemeinden">Free Religious communities</option>
						<option disabled>──────────</option>
						<option value="Sonstiges, nicht kirchensteuerpflichtig">Other / No religion</option>
					</select>
					<span class="input-instructions">Members of some religions must pay the <glossary term="Kirchensteuer">church tax</glossary>.</span>
				</div>
			</div>
		</template>
		<datalist :id="uid('countries')">
			<option v-for="country in sortedCountryList" :key="country[0]" :value="country[1]"></option>
		</datalist>
	</template>
	<template v-if="stage === 'finish'">
		<h2>You're done!</h2>
		<div class="health-insurance-options">
			<button @click="generatePDF">
				{% endraw %}{% include "_css/icons/pdf.svg" %}{% raw %}
				<div>
					<h3>Download the form</h3>
					<p>Print the form, sign it, and bring it to your Anmeldung appointment</p>
				</div>
			</button>
		</div>
		<p>To register your address, you must book a Bürgeramt appointment and go there in person. You can also send someone else to do it for you.</p>
		<div class="health-insurance-options">
			<a href="/guides/anmeldung-in-english-berlin#step-1-get-a-burgeramt-appointment" target="_blank">
				{% endraw %}{% include "_css/icons/calendar.svg" %}{% raw %}
				<div>
					<h3>Book a Bürgeramt appointment</h3>
					<p>You need an appointment to register your address.</p>
				</div>
			</a>
			<button>
				{% endraw %}{% include "_css/icons/translator.svg" %}{% raw %}
				<div>
					<h3>Bring a translator</h3>
					<p>The Anmeldung is easy. You probably don't need a translator, but you can bring one just in case.</p>
				</div>
			</button>
			<button>
				{% endraw %}{% include "_css/icons/sendsomeone.svg" %}{% raw %}
				<div>
					<h3>Pay someone to register you</h3>
					<p>If you don't want to book an appointment and go to the Bürgeramt, hire someone else to do it for you.</p>
				</div>
			</button>
		</div>
	</template>
	<hr>
	<div class="buttons">
		<template v-if="stage === 'start'">
			<button class="button primary" @click="stage = 'oldAddress'">Next step <i class="icon right" aria-hidden="true"></i></button>
		</template>
		<template v-if="stage === 'oldAddress'">
			<button class="button" @click="stage = 'start'"><i class="icon left" aria-hidden="true"></i> Go back</button>
			<button class="button primary" @click="stage = 'addPeople'">Next step <i class="icon right" aria-hidden="true"></i></button>
		</template>
		<template v-if="stage === 'addPeople'">
			<button class="button" @click="stage = 'oldAddress'"><i class="icon left" aria-hidden="true"></i> Go back</button>
			<button class="button" @click="addPerson"><i class="icon person" aria-hidden="true"></i> Add another person</button>
			<button class="button primary" @click="stage = 'finish'">Finish <i class="icon right" aria-hidden="true"></i></button>
		</template>
		<template v-if="stage === 'finish'">
			<button class="button" @click="stage = 'addPeople'"><i class="icon left" aria-hidden="true"></i> Go back</button>
		</template>
	</div>
{% endraw %}
</collapsible>
{% include '_js/constants.js' %}
{% include '_js/utils.js' %}
{% include '_js/vue.js' %}
{% include '_js/vue/collapsible.js' %}
{% include '_js/vue/date-picker.js' %}
{% include '_js/vue/glossary.js' %}
{% include '_js/vue/uniqueIdsMixin.js' %}
{% js %}
	document.querySelectorAll('.anmeldung-form').forEach(
		el => new Vue({
			el: el,
			mixins: [uniqueIdsMixin],
			data() {
				return {
					stage: 'start',
					sortedCountryList: Object.entries(countries).sort((a, b) => a[1].localeCompare(b[1])),
					moveInDate: '',
					newAddress: '',
					newBuildingDetails: '',
					newCity: '',
					newPostCode: '',
					newAddressIsOnlyAddress: true,
					newAddressType: 'main',
					oldAddress: '',
					oldCity: '',
					oldPostCode: '',
					oldCountry: '',
					keepOldAddress: false,
					oldAddressIsMainAddress: false,
					people: [],
					sortedCountryList: Object.entries(countries).sort((a, b) => a[1].localeCompare(b[1])),
				};
			},
			methods: {
				addPerson(){
					this.people.push({
						id: Math.floor(Math.random() * 10000),
						title: '',
						firstName: '',
						lastName: '',
						birthName: '',
						artistName: '',
						nationality: '',
						religion: 'Sonstiges, nicht kirchensteuerpflichtig',
						dateOfBirth: '',
						birthPlace: '',
						showExtraFields: false,
					})
				},
				dateFromString(str) {
					if(str.match(/\d\d\d\d-\d\d-\d\d/)){
						const [year, month, day] = str.split('-').map(n => Number(n, 10));
						return new Date(year, month - 1, day);
					}
					return null;
				},
				formattedDate(date, locale) {
					if(date) {
						return (new Date(date)).toLocaleDateString(locale, {
							year: '2-digit',
							month: 'numeric',
							day: 'numeric',
						});
					}
					return '';
				},
				generatePDF(){
					const textFields = {
						'Tag des EinzugsRow1': this.formattedDate(this.moveInDate, 'de-DE'),
						'Tag des AuszugsRow1': this.formattedDate(this.moveInDate, 'de-DE'),
						'Straße Hausnummer ZusätzeRow1': this.newAddress,
						'Postleitzahl Gemeinde OrtsteilRow1': [this.newPostCode, this.newCity].filter(Boolean).join(', '),
						'Straße Hausnummer ZusätzeRow1_2': this.oldAddress,
						'Postleitzahl GemeindeKreisLandRow1': [this.oldPostCode, this.oldCity].filter(Boolean).join(', '),
						'Bei Zuzug aus dem Ausland StaatRow1': this.oldCountry === 'Germany' ? '' : this.oldCountry,
					};
					const checkboxFields = {
						'alleinige': this.newAddressIsOnlyAddress,
						'Haupt': !this.newAddressIsOnlyAddress && this.newAddressType === 'main',
						'Neben': !this.newAddressIsOnlyAddress && this.newAddressType === 'secondary',
					};

					if(this.people[0]){
						textFields['Vornamen Rufnamen unterstreichen'] = this.people[0].firstName;
						textFields['Geburtsname'] = this.people[0].birthName;
						textFields['Tag Ort Land der Geburt'] = this.people[0].birthPlace;
						textFields['Religionsgesellschaft'] = this.people[0].religion;
						textFields['Staatsangehörigkeiten'] = this.people[0].nationality;
					}

					makePDF('/documents/anmeldung-original.pdf', textFields, checkboxFields, 'anmeldung-form-filled.pdf');
				}
			},
			created() {
				this.addPerson();
			}
		})
	);
{% endjs %}



	</div>
{% endblock %}
