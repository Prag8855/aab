{% include '_js/constants.js' %}
{% include '_js/health-insurance-calculator.js' %}
{% include '_js/utils.js' %}
{% include '_js/vue.js' %}
{% include '_js/vue/age-input.js' %}
{% include '_js/vue/collapsible.js' %}
{% include '_js/vue/eur.js' %}
{% include '_js/vue/glossary.js' %}
{% include '_js/vue/health-insurance-question.js' %}
{% include '_js/vue/income-input.js' %}
{% include '_js/vue/mixins/userDefaultsMixin.js' %}
{% include '_js/vue/occupation-input.js' %}
{% include '_js/vue/mixins/trackedStagesMixin.js' %}
{% include '_js/vue/mixins/uniqueIdsMixin.js' %}
{% js %}
	document.querySelectorAll('collapsible.health-insurance-calculator').forEach(
		el => new Vue({
			el: el,
			mixins: [userDefaultsMixin, uniqueIdsMixin, trackedStagesMixin],
			data() {
				return {
					trackAs: 'Health insurance calculator',
					occupation: null,
					childrenCount: userDefaults.childrenCount,
					yearlyIncome: userDefaults.yearlyIncome,
					inputIncome: 0,
					age: userDefaults.age,
					stage: 'start',
					useMonthlyIncome: userDefaults.useMonthlyIncome,
					formatPercent,
					pflegeversicherung,
					healthInsurance,
				}
			},
			mounted(){
				if(this.useMonthlyIncome){
					this.inputIncome = this.monthlyIncome;
				}
				else{
					this.inputIncome = this.yearlyIncome;
				}
			},
			computed: {
				result() {
					return calculateHealthInsuranceContributions({
						age: +this.age,
						monthlyIncome: +this.monthlyIncome,
						occupation: this.occupation,
						isMarried: true,
						childrenCount: this.childrenCount,
					});
				},
				salaryOrIncome() { return occupations.isEmployed(this.occupation) ? 'salary' : 'income' },
				incomeInputRange() {
					return {
						min: 0,
						max: this.useMonthlyIncome ? Math.ceil(healthInsurance.minFreiwilligMonthlyIncome/250)*250 : Math.ceil(healthInsurance.minFreiwilligMonthlyIncome*12/1000)*1000,
						step: this.useMonthlyIncome ? 250 : 1000,
					};
				},
				monthlyIncome() {
					return this.yearlyIncome / 12;
				},
				minTotal() {
					return this.result.options.cheapest.total;
				},
				maxTotal() {
					return this.result.options.mostExpensive.total;
				},
				baseContributionPercentage() {
					return (this.result.baseContribution.totalRate * 100).toFixed(1);
				},
				showIncomeInput() {
					return this.occupation !== 'unemployed';
				},
				showFreeOptions(){
					return this.flag('familienversicherung-parents')
						|| this.flag('familienversicherung-spouse')
						|| this.flag('alg-i-buergergeld')
						|| this.flag('ehic');
				},
				yourSponsorsHave() {
					if(this.flag('familienversicherung-parents') && this.flag('familienversicherung-spouse')){
						return 'your parents or your spouse have';
					}
					else if(this.flag('familienversicherung-spouse')){
						return 'your spouse has';
					}
					else if(this.flag('familienversicherung-parents')){
						return 'your parents have';
					}
				},
				privateCost() {
					if(!this.flag('private')){
						return;
					}

					if(this.result.tarif === 'student' || this.flag('student-30plus')){
						return {{ OTTONOVA_STUDENT_COST }};
					}
					else if(this.result.tarif === 'selfEmployed'){
						return {{ OTTONOVA_SELFEMPLOYED_COST }};
					}
					else if(this.result.tarif === 'employee'){
						return {{ OTTONOVA_EMPLOYEE_COST }};
					}
				},
				ottonovaLink() {
					if(this.occupation === 'student'){
						return "/out/ottonova-students";
					}
					else if(occupations.isEmployed(this.occupation)){
						return "/out/ottonova-employees";
					}
					else if(occupations.isSelfEmployed(this.occupation)){
						return "/out/ottonova-freelancers";
					}
					return "/out/ottonova";
				},
			},
			methods: {
				flag(flagName){
					return this.result.flags.has(flagName);
				},
				eur(num) {
					return formatCurrency(num, false, '€', false);
				},
				toggleUseMonthlyIncome(){
					this.useMonthlyIncome = !this.useMonthlyIncome;
				},
			},
			watch: {
				inputIncome(newIncome){
					this.yearlyIncome = this.useMonthlyIncome ? newIncome * 12 : newIncome;
				},
				occupation(newOccupation) {
					if(newOccupation === 'unemployed') {
						this.yearlyIncome = 0;
					}
					else if(newOccupation === 'employee') {
						this.yearlyIncome = 45000;
					}
				},
			}
		})
	);
{% endjs %}

<collapsible class="health-insurance-calculator" ref="collapsible" {% if static|default %}static{% endif %}>
{% raw %}
	<template v-slot:header>Health insurance calculator</template>

	<template v-if="stage === 'start'">
		<h3>What is your occupation?</h3>
		<ul class="buttons grid">
			<li>
				<button @click.prevent="occupation = 'employee'; stage = 'questions'">
					{% endraw %}{% include "_css/icons/job.svg" %}{% raw %}
					Employee
				</button>
			</li>
			<li>
				<button @click.prevent="occupation = ''; stage = 'questions'">
					{% endraw %}{% include "_css/icons/student.svg" %}{% raw %}
					Student
				</button>
			</li>
			<li>
				<button @click.prevent="occupation = 'selfEmployed'; stage = 'questions'">
					{% endraw %}{% include "_css/icons/business.svg" %}{% raw %}
					Self-employed
				</button>
			</li>
			<li>
				<button @click.prevent="occupation = ''; stage = 'questions'">
					{% endraw %}{% include "_css/icons/helper.svg" %}{% raw %}
					Intern
				</button>
			</li>
			<li>
				<button @click.prevent="occupation = 'azubi'; stage = 'questions'">
					{% endraw %}{% include "_css/icons/helper.svg" %}{% raw %}
					Apprentice
				</button>
			</li>
			<li>
				<button @click.prevent="occupation = 'unemployed'; stage = 'questions'">
					{% endraw %}{% include "_css/icons/visiting.svg" %}{% raw %}
					Unemployed
				</button>
			</li>
		</ul>
	</template>

	<template v-if="stage === 'questions'">
		<h3>Tell us a bit more about you</h3>
		<div class="form-group show-errors" v-if="showIncomeInput">
			<label :for="uid('income')">
				{{ salaryOrIncome === 'salary' ? 'Salary' : 'Income' }}
			</label>
			<div class="input-group">
				<income-input :id="uid('income')" v-model="inputIncome"></income-input>
				€
				<button class="toggle" @click.prevent="toggleUseMonthlyIncome">per {{ useMonthlyIncome ? 'month' : 'year' }}</button>
				before taxes
			</div>
		</div>
		<div class="form-group show-errors">
			<label :for="uid('age')">
				Age
			</label>
			<label class="input-group">
				<age-input :id="uid('age')" v-model="age"></age-input>
				years old
			</label>
		</div>
		<div class="form-group">
			<label :for="uid('children-count')">
				Children
			</label>
			<select :id="uid('children-count')" v-model="childrenCount">
				<option :value="0">No children</option>
				<option :value="1">1 child</option>
				<option :value="2">2 children</option>
				<option :value="3">3 children</option>
				<option :value="4">4 children</option>
				<option :value="5">5 children</option>
				<option :value="6">6+ children</option>
			</select>
		</div>
		<hr>
		<div class="buttons bar">
			<button class="button" @click.prevent="stage = 'start'">
				<i class="icon left" aria-hidden="true"></i> Go back
			</button>
			<button class="button primary" @click.prevent="stage = 'insuranceOptions'">
				See options <i class="icon right" aria-hidden="true"></i>
			</button>
		</div>
	</template>
	<template v-if="stage === 'insuranceOptions'">
		<template v-if="showFreeOptions">
			<h3>Free health insurance</h3>
			<p>You can get <strong>free public health insurance</strong> because you have a low income.</p>
			<ul class="buttons list">
				<li>
					<a v-if="flag('alg-i-buergergeld')" title="Learn more about state-sponsored health insurance" href="/guides/german-health-insurance#free-health-insurance" target="_blank">
						{% endraw %}{% include "_css/icons/bank.svg" %}{% raw %}
						<div>
							<h3>ALG I, Elterngeld or Bürgergeld</h3>
							<p>
								If you get <glossary>ALG I</glossary>, <glossary>Bürgergeld</glossary> or <glossary>Elterngeld</glossary>, you get free health insurance.
							</p>
						</div>
						<output>
							<eur :amount="0"></eur> <small>per month</small>
						</output>
					</a>
				</li>
				<li>
					<a v-if="flag('familienversicherung-spouse') || flag('familienversicherung-parents')" title="Learn more about family health insurance" href="/guides/german-health-insurance#free-health-insurance" target="_blank">
						{% endraw %}{% include "_css/icons/family.svg" %}{% raw %}
						<div>
							<h3><glossary term="Familienversicherung">Family insurance</glossary></h3>
							<p>
								If {{ yourSponsorsHave }} <glossary term="gesetzliche Krankenversicherung">public health insurance</glossary>, it covers you for free.
							</p>
						</div>
						<output>
							<eur :amount="0"></eur> <small>per month</small>
						</output>
					</a>
				</li>
				<li>
					<a v-if="flag('ehic')" title="Learn more about the EHIC" href="/guides/german-health-insurance#insurance-from-other-eu-countries" target="_blank">
						{% endraw %}{% include "_css/icons/passport.svg" %}{% raw %}
						<div>
							<h3>European Health Insurance Card</h3>
							<p>Your insurance from another EU country might cover you for free.</p>
						</div>
						<output>
							<eur :amount="0"></eur> <small>per month</small>
						</output>
					</a>
				</li>
			</ul>
			<hr>
		</template>
		<h3>Public health insurance</h3>
		<p>
			<template v-if="showFreeOptions">If you can't get free health insurance, you must pay</template>
			<template v-if="!showFreeOptions">Public health insurance costs</template>
			<strong>
				<output v-if="maxTotal === 0">
					<eur :amount="0"></eur>
				</output>
				<output v-if="eur(minTotal.personalContribution) === eur(maxTotal.personalContribution) && maxTotal.personalContribution > 0">
					<eur :amount="maxTotal.personalContribution"></eur>
				</output>
				<output v-if="eur(minTotal.personalContribution) != eur(maxTotal.personalContribution) && maxTotal.personalContribution > 0">
					<eur :amount="minTotal.personalContribution" no-symbol></eur>
					to
					<eur :amount="maxTotal.personalContribution"></eur>
				</output>
				per month</strong>, depending on the insurer. This includes <glossary term="Pflegeversicherung">long-term care insurance</glossary>.
			<template v-if="flag('max-contribution')">
				You make over <eur :amount="healthInsurance.maxMonthlyIncome" :cents="false"></eur> per month, so you pay the <glossary term="Höchstbeitrag">maximum price</glossary>.
			</template>
			<template v-else-if="flag('min-contribution') && !showFreeOptions">
				You make under <eur :amount="healthInsurance.minMonthlyIncome" :cents="false"></eur> per month, so you pay the <glossary term="Mindestbeitrag">minimum price</glossary>.
			</template>
			<template v-else-if="flag('azubi-free')">
				You make under <eur :amount="healthInsurance.azubiFreibetrag"></eur> per month, so your employer pays for your health insurance. You must still choose an insurer.
			</template>
		</p>
		<p>There are 94 public health insurers. Their cost and coverage are similar. Barmer and Techniker Krankenkasse are the most popular options.</p>
		<ul class="buttons">
			<li>
				<a title="Sign up with BARMER" href="/out/barmer" target="_blank">
					{% endraw %}{% include "_css/icons/health-insurance/logo-barmer.svg" %}{% raw %}
					<div>
						<h3>Barmer</h3>
						<p>Best service for expats. More choice of psychotherapists.</p>
					</div>
					<output>
						<eur :amount="result.options.barmer.total.personalContribution"></eur> <small>per month</small>
					</output>
				</a>
			</li>
			<li>
				<a title="Sign up with Techniker Krankenkasse" href="/out/feather-tk" target="_blank">
					{% endraw %}{% include "_css/icons/health-insurance/logo-tk.svg" %}{% raw %}
					<div>
						<h3>Techniker Krankenkasse</h3>
						<p>Biggest German health insurer. English-speaking support.</p>
					</div>
					<output>
						<eur :amount="result.options.tk.total.personalContribution"></eur> <small>per month</small>
					</output>
				</a>
			</li>
		</ul>
		<template v-if="privateCost">
			<hr>
			<h3>Private health insurance</h3>
			<p>
				<glossary term="private Krankenversicherung">Private health insurance</glossary> can be better and cheaper than public health insurance. It depends on your situation.
			</p>
			<ul class="buttons list">
				<li>
					<a @click.prevent.prevent="stage = 'askABroker'" title="Choose a health insurance broker" href="/guides/german-health-insurance#insurance-brokers" target="_blank">
						{% endraw %}{% include "_css/icons/help.svg" %}{% raw %}
						<div>
							<h3>Ask a health insurance broker</h3>
							<p>Don't choose private health insurance yourself; it's a really bad idea. Ask a broker to help you choose.</p>
						</div>
					</a>
				</li>
				<li>
					<a title="Get a quote from Feather" href="/out/feather-private" target="_blank">
						{% endraw %}{% include "_css/icons/health-insurance/logo-feather.svg" %}{% raw %}
						<div>
							<h3>Get a quote from Feather</h3>
							<p>They sell insurance from a few insurers. I got my health insurance from them. It's a great company.</p>
						</div>
					</a>
				</li>
				<li>
					<a title="Get a quote from Ottonova" :href="ottonovaLink" target="_blank">
						{% endraw %}{% include "_css/icons/health-insurance/logo-ottonova.svg" %}{% raw %}
						<div>
							<h3>Get a quote from Ottonova</h3>
							<p>They sell their own health insurance. They speak English.</p>
						</div>
						<output v-if="privateCost">
							<small>From</small> <eur :amount="privateCost"></eur> <small>per month</small>
						</output>
					</a>
				</li>
			</ul>
		</template>
		<template v-if="flag('ksk')">
			<hr>
			<h3>Other options</h3>
			<ul class="buttons list">
				<li>
					<a title="Learn more about the KSK" href="/guides/ksk-kuenstlersozialkasse" target="_blank">
						{% endraw %}{% include "_css/icons/liability.svg" %}{% raw %}
						<div>
							<h3>Join the Künstlersozialkasse</h3>
							<p>If you are a freelance artist or publicist, join the KSK. They pay half of your health insurance. It's always worth it.</p>
						</div>
					</a>
				</li>
			</ul>
		</template>
		<hr>
		<h3>Avoid mistakes, ask for help</h3>
		<p>Don't choose health insurance yourself. You can make expensive mistakes. An insurance broker can help you get better, cheaper health insurance. Their help is free.</p>
		<ul class="buttons list">
			<li>
				<button @click.prevent.prevent="stage = 'askABroker'">
					{% endraw %}{% include "_css/icons/help.svg" %}{% raw %}
					<div>
						<h3>Ask an expert</h3>
						<p>Get free advice in English by phone, email or WhatsApp. It's the best way to choose health insurance.</p>
					</div>
				</button>
			</li>
		</ul>

		<div class="buttons bar">
			<button class="button" @click.prevent="stage = 'questions'">
				<i class="icon left" aria-hidden="true"></i> Go back
			</button>
			<button class="button primary" @click.prevent="stage = 'askABroker'">
				Ask an expert <i class="icon right" aria-hidden="true"></i>
			</button>
		</div>
	</template>
	<health-insurance-question
		v-if="stage === 'askABroker'"
		:age="age"
		:income="yearlyIncome"
		:occupation="occupation"
		:children-count="childrenCount"
		>
		<template v-slot:form-buttons>
			<button class="button" @click.prevent="stage = 'insuranceOptions'">
				<i class="icon left" aria-hidden="true"></i> Go back
			</button>
		</template>
		<template v-slot:after-confirmation>
			<div class="buttons bar">
				<button class="button" @click.prevent="stage = 'start'">
					<i class="icon left" aria-hidden="true"></i> Go back
				</button>
			</div>
		</template>
	</health-insurance-question>
{% endraw %}
</collapsible>