{% include '_js/vue.js' %}
{% include '_js/vue/collapsible.js' %}
{% include '_js/vue/date-picker.js' %}
{% include '_js/vue/multiStageMixin.js' %}
{% include '_js/vue/trackedStagesMixin.js' %}
{% include '_js/vue/uniqueIdsMixin.js' %}
{% js %}
	document.querySelectorAll('collapsible.feedback-blue-card').forEach(
		el => new Vue({
			el: el,
			mixins: [uniqueIdsMixin, multiStageMixin, trackedStagesMixin],
			data() {
				return {
					trackAs: 'Blue Card feedback',
					isLoading: false,
					nationality: null,
					userNotes: '',
					emailAddress: '',

					steps: {
						application: {
							checkboxTitle: "I have applied in Berlin",
							dateFieldTitle: "Application date",
							completed: null,
							date: null,
						},
						response: {
							checkboxTitle: "The Ausländerbehörde responded",
							dateFieldTitle: "First response date",
							completed: null,
							date: null,
						},
						appointment: {
							checkboxTitle: "The Ausländerbehörde gave me an appointment",
							dateFieldTitle: "Appointment date",
							completed: null,
							date: null,
						},
						pickup: {
							checkboxTitle: "I received my Blue Card",
							dateFieldTitle: "Pick-up date",
							completed: null,
							date: null,
						},
					},

					stages: [
						'start',
						'email',
						'finish',
					],
					inputsToFocus: {
						email: () => this.$refs.emailInput,
					},
				};
			},
			methods: {
				nextStage(){
					if(validateForm(this.$el)){
						const allStagesComplete = Object.values(this.steps).every(s => s.completed);
						if(this.stage === 'start' && allStagesComplete){
							this.stageIndex += 2; // Skip email step if there is no more feedback to give
						}
						else{
							this.stageIndex += 1;
						}
					}
				},
				onStepCompletionChange(key){
					const changedStepIndex = Object.keys(this.steps).indexOf(key);
					Object.values(this.steps).forEach((step, index) => {
						// Tick all previous steps
						if(index < changedStepIndex && this.steps[key].completed){
							step.completed = true;
						}

						// Untick all following steps
						if(index > changedStepIndex && !this.steps[key].completed){
							step.completed = false;
						}
					})
				},
				submitFeedback(){
				},
				setFeedbackReminder(){
				},
			},
		})
	);
{% endjs %}

<collapsible class="feedback-blue-card" aria-label="Feedback form: Blue Card" {% if static|default %}static{% endif %} v-cloak>
{% raw %}
	<template v-slot:header>
		<small>Give feedback, help others</small>
		How is your Blue Card application going?
	</template>
	<template v-if="stage === 'start'">
		<template  v-for="(step, key, index) in steps" :key="key">
			<div class="form-group no-label">
				<div class="input-group vertical">
					<label class="checkbox">
						<input type="checkbox" v-model="step.completed" @change="onStepCompletionChange(key)">
						{{ step.checkboxTitle }}
					</label>
				</div>
			</div>
			<div class="inter-step" v-if="!step.completed && index != Object.keys(steps).length - 1"></div>
			<div class="form-group inter-step required" v-if="step.completed">
				<label :for="uid(key) + '-date-day'">{{ step.dateFieldTitle }}</label>
				<date-picker v-model="step.date" :id="uid(key) + '-date'" required></date-picker>
			</div>
		</template>
		<template v-if="steps.application.completed">
			<hr>
			<div class="form-group required">
				<label :for="uid('nationality')">Nationality</label>
				<country-input
					country-code
					v-model="nationality"
					:id="uid('nationality')"
					required></country-input>
				<span class="input-instructions">Your nationality affects the processing time</span>
			</div>
			<div class="form-group">
				<label :for="uid('userNotes')">Notes and advice</label>
				<textarea placeholder="Add helpful information for other readers" v-model="userNotes" :id="uid('userNotes')"></textarea>
			</div>
		</template>
	</template>
	<template v-if="stage === 'email'">
		<p>
			<strong>Thank you for your feedback!</strong> It will help a lot of people.
		</p>
		<hr>
		<p>Can you give more feedback when you get your residence permit? It would be very helpful. I can remind you by email.</p>
		<div class="form-group">
			<label :for="uid('email')">Email address</label>
			<input ref="emailInput" v-model="emailAddress" type="email" :id="uid('email')" autocomplete="email" required>
			<span class="input-instructions">You will get a reminder in 2 months and in 6 months. Nothing else.</span>
		</div>
	</template>
	<template v-if="stage === 'finish'">
		<p>
			<strong>Thank you for your feedback!</strong> It will help a lot of people.
		</p>
	</template>
	<hr v-if="steps.application.completed && stage !== 'finish'">
	<div class="buttons" v-if="steps.application.completed && stage !== 'finish'">
		<button v-if="stage !== 'start' && stage !== 'finish'" class="button" @click="stageIndex -= 1"><i class="icon left" aria-hidden="true"></i> Go back</button>
		<button class="button primary" v-if="stage === 'start'" @click="nextStage">Send feedback</button>
		<button class="button primary" v-if="stage === 'email'" @click="nextStage">Remind me</button>
	</div>
{% endraw %}
</collapsible>