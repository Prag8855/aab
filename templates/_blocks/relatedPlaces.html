<style>{% scss %}
	@import '_css/animations.scss';
	@import '_css/breakpoints.scss';
	@import '_css/mixins.scss';

	#places{
	    @include text-block;
	    @include box;
	    display: grid;
	    grid-template-columns: 1fr minmax(200px,300px);
	    height: 80vh;
	    box-shadow: var(--shadow-s);

	    #places-map{
	        background: var(--c-bg-image);
	        img{
	            background-color:transparent;
	            border: none;
	            margin:0;
	        }
	    }

	    ol{
	        counter-reset: list;
	        overflow:auto;
	        margin: 0;
	        padding: 0 var(--m);

	        li{
	            border-bottom: var(--b-box);

	            position: relative;
	            display: grid;
	            grid-template-columns:3ch 1fr;
	            font-size: var(--f-s);

	            margin: 0;
	            padding:var(--m) 0;

	            &:before{position: static;}

	            > * {
	                grid-column-start: 2;
	            }

	            &.highlighted{
	                border-radius: var(--b-radius);
	                animation: highlight 1.5s ease 0s 1 alternate;
	            }

	            h4{
	                @include text-bold;
	            }
	            address{
	                overflow: hidden;
	                text-overflow: ellipsis;

	                a{
	                    color: var(--c-text-light);
	                    white-space: nowrap;
	                }
	            }
	            p{
	                margin: var(--s) 0 0;
	            }

	            &:last-child{border-bottom: none}
	        }
	    }

	    @include only-phone{
	        display: flex;
	        flex-direction: column;
	        height: auto;
	        border-left: 0;
	        border-right: 0;
	        border-top: 0;
	        margin-left: calc(var(--w-page-border) * -1);
	        margin-right: calc(var(--w-page-border) * -1);

	        #places-map{
	            height: 60vh;
	        }
	    }

	    @include only-print{
	        display: block;
	        margin: 0;
	        padding: 0;
	        height: auto;
	        border: none;
	    }
	}
{% endscss %}</style>
<aside id="places">
	<div id="places-map" class="no-print">
		<noscript>This map needs JavaScript to work.</noscript>
	</div>
	<ol>
		{% for place in entry.related_places %}
		<li id="place-{{ loop.index }}">
			<h4>
				{% if place.website %}
					<a title="Website of {{ place.name }}" target="_blank" href="{{ place.website }}" target="_blank" position="{{ loop.index }}">{{ place.name }}</a>
				{% else %}
					{{ place.name }}
				{% endif %}
			</h4>
			<address>
				<a href="https://www.google.com/maps/search/{{ place.name|urlencode }}/@{{ place.latitude }},{{ place.longitude }}" target="_blank" title="View on Google Maps">
					{{ place.address }}
				</a>
			</address>
			{%- if place.description|default -%}
				<p>{{ place.description }}</p>
			{%- endif -%}
			{%- if place.accepts_public_insurance|default == 'Yes' -%}
				<p>Accepts public health insurance.</p>
			{%- endif -%}
		</li>
		{% endfor %}
	</ol>
</aside>
{% js %}{% include "_js/googleMapsMarkerClusterer.js" %}{% endjs %}
<script>
function initMap() {
	const placesMap = document.getElementById('places-map');
	const googleMap = new google.maps.Map(placesMap, {
		disableDefaultUI: true,
		zoomControl: true,
		mapTypeControl: false,
		scaleControl: true,
		streetViewControl: false,
		rotateControl: false,
		fullscreenControl: false
	});
	const markers = [];
	{% for place in entry.related_places %}
		markers.push(new google.maps.Marker({
			position: {lat: {{ place.latitude }}, lng: {{ place.longitude }} },
			title: "{{ place.name }}",
			label: "{{ loop.index }}"
		}));
	{% endfor %}
	const bounds = new google.maps.LatLngBounds();
	markers.forEach((marker) => {
		bounds.extend(marker.position)
		marker.addListener('click', function() {
			const placeLi = document.getElementById(`place-${marker.label}`);
			placeLi.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
			placeLi.classList.add('highlighted');
			setTimeout(() => placeLi.classList.remove('highlighted'), 2000);
		});
	});
	new MarkerClusterer(googleMap, markers);

	document.querySelectorAll('#places address a').forEach((a, index) => {
		a.addEventListener('click', (e) => {
			e.preventDefault();
			googleMap.setZoom(14);
			googleMap.panTo(markers[index].position);
			placesMap.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
		});
	})
	googleMap.fitBounds(bounds);
}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
