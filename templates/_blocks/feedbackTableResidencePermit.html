{% include '_js/vue.js' %}
{% include '_js/utils.js' %}
{% js %}
	document.querySelectorAll('.residence-permit-feedback-table').forEach(
		el => new Vue({
			el: el,
			mixins: [],
			data() {
				return {
					isLoading: true,
					resultPages: [], // An array of arrays. First a list of pages, then items on that page
					page: null,
					resultCount: 0,
					itemsPerPage: 10,

					residencePermitType: null,
					residencePermitTypes: {
						BLUE_CARD: "Blue Card",
						FAMILY_REUNION_VISA: "Family reunion visa",
						FREELANCE_VISA: "Freelance visa",
						PERMANENT_RESIDENCE: "Permanent residence",
						STUDENT_VISA: "Student visa",
						WORK_VISA: "Work visa",
					},
					department: null,
					departments: {
						A1_A5: 'A1, A5',
						A2_A3_A4: 'A2, A3, A4',
						B1_B2_B3_B4: 'B1, B2, B3, B4',
						B6: 'B6',
						E1: 'E1',
						E2: 'E2',
						E3: 'E3',
						E4: 'E4',
						E5: 'E5',
						E6: 'E6',
					},
				};
			},
			async mounted(){
				this.goToPage(1);
			},
			computed: {
				apiEndpoint(){
					const querystring = new URLSearchParams({ page: this.page });
					if(this.residencePermitType){
						querystring.append('residence_permit_type', this.residencePermitType);
					}
					if(this.department){
						querystring.append('department', this.department);
					}
					return '/api/forms/residence-permit-feedback.json?' + querystring.toString();
				},
				pageCount(){
					return Math.ceil(this.resultCount / this.itemsPerPage);
				},
				pageNumbers(){
					return Array.from({length: this.pageCount}, (_, i) => i + 1);
				},
				resultsPage(){
					return this.isLoading ? [] : this.resultPages[this.page];
				}
			},
			methods: {
				async goToPage(page){
					this.page = page;
					Vue.nextTick(() => {
						this.$refs.topOfPage.scrollIntoView();
					});

					if(!this.resultPages[page]){
						this.isLoading = true;
						response = await (await fetch(this.apiEndpoint)).json();
						this.resultCount = response.count;
						this.resultPages[page] = response.results.map(r => {
							r.modification_date = new Date(r.modification_date);
							r.application_date = new Date(r.application_date);
							r.first_response_date = r.first_response_date ? new Date(r.first_response_date) : null;
							r.appointment_date = r.appointment_date ? new Date(r.appointment_date) : null;
							r.pick_up_date = r.pick_up_date ? new Date(r.pick_up_date) : null;
							return r;
						});
						this.isLoading = false;
					}
				},
				formatDate(date){
					if(date) {
						const dateObj = (date instanceof Date) ? date : dateFromString(date);
						return dateObj.toLocaleDateString("en-US", {
							year: 'numeric',
							month: 'long',
							day: 'numeric',
						});
					}
					return '';
				},
				formatTimeDelta,
				waitTime(date1, date2) {
					if(date2 > date1){
						`Will wait ${formatTimeDelta(date1, date2)}`
					}
					return `${formatTimeDelta(date1, date2)} passed`;
				}
			},
			watch: {
				department(){
					this.resultPages = [];
					this.goToPage(1);
				},
				residencePermitType(){
					this.resultPages = [];
					this.goToPage(1);
				},
			}
		})
	);
{% endjs %}

{% raw %}
<div class="residence-permit-feedback-table feedback-table">
	<div class="filter-group" ref="topOfPage">
		<select v-model="residencePermitType">
			<option :value="null">All residence permits</option>
			<option disabled>──────────</option>
			<option v-for="(name, key) in residencePermitTypes" :key="key" :value="key">{{ name }}</option>
		</select>
		<select v-model="department">
			<option :value="null">All departments</option>
			<option disabled>──────────</option>
			<option v-for="(name, key) in departments" :key="key" :value="key">{{ name }}</option>
		</select>
	</div>
	<div class="loading" v-if="isLoading"></div>
	<div v-cloak class="feedback-item" v-for="result in resultsPage" v-if="!isLoading" :key="result.modification_date">
		<h3>
			{{ residencePermitTypes[result.residence_permit_type] }}
			<template v-if="result.pick_up_date">in {{ formatTimeDelta(result.application_date, result.pick_up_date) }}</template>
			&mdash; {{ departments[result.department] }}
		</h3>

		<div class="step completed">
			<input type="checkbox" checked disabled>
			<span class="description">Applied on {{ formatDate(result.application_date) }}</span>
			<span class="duration">
				<template v-if="result.first_response_date">
					{{ waitTime(result.application_date, result.first_response_date) }}
				</template>
				<template v-else>
					{{ waitTime(result.application_date, result.modification_date) }}
				</template>
			</span>
		</div>

		<div class="step">
			<input type="checkbox" :checked="result.first_response_date" disabled>
			<span class="description">
				<template v-if="result.first_response_date">
					First response on {{ formatDate(result.first_response_date) }}
				</template>
				<template v-else>
					No response as of {{ formatDate(result.modification_date) }}
				</template>
			</span>
			<span class="duration" v-if="result.first_response_date || result.appointment_date">
				<template v-if="result.appointment_date">
					{{ waitTime(result.first_response_date, result.appointment_date) }}
				</template>
				<template v-if="result.first_response_date && !result.appointment_date">
					{{ waitTime(result.first_response_date, result.modification_date) }}
				</template>
			</span>
		</div>

		<div class="step">
			<input type="checkbox" :checked="result.appointment_date" disabled>
			<span class="description">
				<template v-if="result.appointment_date">
					Appointment on {{ formatDate(result.appointment_date) }}
				</template>
				<template v-else>
					No appointment <template v-if="result.first_response_date">as of {{ formatDate(result.modification_date) }}</template>
				</template>
			</span>
			<span class="duration" v-if="result.appointment_date && result.pick_up_date">
				{{ waitTime(result.appointment_date, result.pick_up_date) }}
			</span>
			<span class="duration" v-if="result.appointment_date && !result.pick_up_date && result.appointment_date <= result.modification_date">
				{{ waitTime(result.appointment_date, result.modification_date) }}
			</span>
		</div>

		<div class="step">
			<input type="checkbox" :checked="result.pick_up_date" disabled>
			<span class="description">
				<template v-if="result.pick_up_date">
					Picked up residence permit on {{ formatDate(result.pick_up_date) }}
				</template>
				<template v-else>
					No pick-up date <template v-if="result.appointment_date">as of {{ formatDate(result.modification_date) }}</template>
				</template>
			</span>
		</div>

		<div v-if="result.notes.length" class="notes">{{ result.notes.trim() }}</div>
	</div>
	<nav v-cloak class="pagination" aria-label="Pagination">
		<button v-if="page > 1" @click.prevent="goToPage(page - 1)"><i class="icon left"></i></button>
		<button :class="{current: pageNumber === page}"
			v-for="pageNumber in pageNumbers" :key="pageNumber"
			@click.prevent="goToPage(pageNumber)"
			:title="'Go to page ' + pageNumber"
			:disabled="page === pageNumber">{{ pageNumber }}</button>
		<button v-if="page < pageCount" @click.prevent="goToPage(page + 1)"><i class="icon right"></i></button>
	</nav>
</div>
{% endraw %}