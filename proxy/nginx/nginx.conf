user  nginx;
worker_processes  auto;
pid /var/run/nginx.pid;

error_log /var/log/nginx/error.log notice;

events {
    worker_connections 4096;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    charset utf-8;
    gzip_static on;
    client_max_body_size 0;
    sendfile on;
    sendfile_max_chunk 1m;

    keepalive_timeout 65;

    map_hash_bucket_size 128;
    map $status $loggable { 
        ~^[123] 0;
        499 0;
        444 0;
        426 0;
        default 1;
    }
    log_format main '$remote_addr [$time_iso8601] "$request" $status "$http_referer" "$http_user_agent"';
    log_format post_errors escape=json 'ERR [$time_iso8601] $request_body - $http_accept_language - $http_user_agent';

    include /etc/nginx/configs/redirects.conf;

    proxy_cache_path /var/run/nginx-cache/jscache levels=1:2 keys_zone=jscache:100m inactive=30d  use_temp_path=off max_size=100m;
    
    # ==========================================================================
    # HTTP redirect to HTTPS
    # ==========================================================================
    server {
        listen 80;
        listen [::]:80;
        server_name allaboutberlin.com localhost;
        access_log off;
        return 301 https://$host$request_uri;
    }

    # ==========================================================================
    # Main logic
    # ==========================================================================
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name allaboutberlin.com localhost;
        root "/var/www/html";


        # The internal docker DNS. Required to make proxy_pass URL variables work.
        resolver 127.0.0.11 valid=30s;


        # Logging
        server_tokens off;
        error_log off;
        log_not_found on;
        access_log /var/log/nginx/access.log main if=$loggable;

        location ~ /apple-touch-icon(|-\d+x\d+)(|-precomposed).png {
            return 204;
            access_log off;
        }
        location = /favicon.ico {
            return 301 /staticimages/favicon.png;
            access_log off;
        }


        # Error pages
        error_page 404 /404.html;


        # Remove trailing slashes
        rewrite ^/(.*)/$ /$1 permanent;

        # Remove double slashes
        merge_slashes off;
        rewrite (.*)//+(.*) $1/$2 permanent;


        # Change in site structure (2023-02-20)
        location ~* ^/(images|illustrations)/_[^/]+/(.+)$ {
            rewrite ^/(images|illustrations)/_[^/]+/(.+)$ /$1/$2 permanent;
        }

        # TODO: Might not be needed anymore
        location ~* ^/guides/[^/\.]*\.webp$ {
            rewrite ^/guides/([^/\.]*)\.webp$ /guides/$1.png permanent;
        }


        # Caching and expiration on assets
        location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp3|mp4|ogg|ogv|webm|htc|webp)$ {
            etag off;
            expires 1y;
            access_log off;

            include /etc/nginx/configs/default-headers.conf;
            add_header Cache-Control "public";
        }

        # Caching and expiration on fonts
        location ~* \.(?:ttf|ttc|otf|eot|woff|woff2)$ {
            etag off;
            add_header "Access-Control-Allow-Origin" "*";
            expires 1y;
            access_log off;

            include /etc/nginx/configs/default-headers.conf;
            add_header Cache-Control "public";
        }


        # GZIP compression
        include /etc/nginx/configs/compression.conf;

        include /etc/nginx/configs/default-headers.conf;
        include /etc/nginx/configs/ssl.conf;
        include /etc/nginx/configs/api.conf;

        # Don't allow .html extension. It's stripped from the URL
        location ~ \.html$ {
            return 404;
        }
        location ~ /index$ {
            return 404;
        }

        # The main thing
        location / {
            # Apply the redirects from redirects.conf
            if ($redirects301) {
                rewrite (*UTF8)^ $redirects301 permanent;
            }

            if ($redirects302) {
                rewrite (*UTF8)^ $redirects302 redirect;
            }

            # Try loading the literal file path. Failing that, treat it as an HTML page.
            try_files $uri @html;

            expires 1d;
        }

        location @html {
            # If returning an HTML page, add the extra page headers
            include /etc/nginx/configs/page-headers.conf;

            try_files $uri.html $uri/index.html =404;

            expires 1d;
        }
        
        location = /404.html {
            include /etc/nginx/configs/page-headers.conf;
            internal;
        }

    }

    # Ignore requests with wrong domain name
    server {
        listen 80 default_server;
        server_name "";
        access_log off;
        error_log off;
        return 444;
    }
    server {
        listen 443 default_server;
        server_name "";
        ssl_certificate /etc/ssl-certs/full-chain.pem;
        ssl_certificate_key /etc/ssl-certs/private-key.pem;
        access_log off;
        error_log off;
        return 444;
    }

}
