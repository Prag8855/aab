{% extends "tools/entry.html.jinja" %}

{% block postHead %}
	{{ super() }}
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css" rel="stylesheet"/>
	<script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>
	<style>
		body, html{
			height: 100%;
		}
		body{
			grid-template-rows: var(--h-header) 1fr auto!important;
		}
		#map {
			color: var(--c-text);
			top:0; bottom:0; width:100%;
			border-radius: var(--b-radius);
			box-shadow: var(--shadow-l);
		}
	</style>
{% endblock %}

{% block main %}
	<main aria-label="Map">
		<div id="map"></div>
	</main>
	<div class="sidebar no-print" data-nosnippet aria-hidden="true">
		<h2>Rent prices in <span id="location">Berlin</span></h2>
		<p>This map shows the <strong>median warm rent per m²</strong>, based on <span id="sampleSize">thousands of</span> apartments listed in December 2025.</p>
		<small>Data from <a href="https://www.homeboy.immo/en">Homeboy</a>, December 2025</small>
		<hr>
		<div class="form-group">
			<label>Postal code</label>
			<input
				id="plzInput"
				class="postalcode-input"
				placeholder="12345"
				type="text"
				inputmode="numeric"
				pattern="[0-9]{5}"
				minlength="5"
				maxlength="5"
				autocomplete="postal-code"
				title="Postal code (Postleitzahl)"
				>
		</div>
		<div class="form-group">
			<span class="label">Median rent</span>
			<span>€29/m2</span>
		</div>
	</div>
{% endblock %}

{% include '_js/utils/currency.js' %}
{% js %}
// Initialize MapLibre
const map = new maplibregl.Map({
	container: 'map',
	style: {% include "tools/rent-map/_mapStyle.json" %},
	center: [13.405, 52.52],
	zoom: 10,
	attributionControl: false
})
.addControl(new maplibregl.AttributionControl({compact: true}));

function getFeatureBounds(f){
	return f.geometry.coordinates
		.flat(f.geometry.type === "MultiPolygon" ? 2 : 1)
		.reduce(
			(bounds, coord) => bounds.extend(coord),
			new maplibregl.LngLatBounds()
		)
}

// Add interactive GeoJSON layer
const plzInput = document.getElementById("plzInput");
const sampleSizeElement = document.getElementById('sampleSize');
const locationElement = document.getElementById('location');
let sampleSize = null;
map.on('load', () => {
	let hoveredFeature = undefined;

	fetch('/tools/rent-map/data.json?v={{ commit_id[0:10] }}')
		.then(r => r.json())
		.then(mapData => {
			// Color calculation
			const rents = mapData.features.map(d => d.properties['median']);
			const minRent = Math.min(...rents);
			const maxRent = Math.max(...rents);
			sampleSize = mapData.features.reduce((total, f) => total + f.properties.count, 0);
			sampleSizeElement.innerHTML = Intl.NumberFormat("en-US").format(sampleSize);

			mapData.features.forEach(f => {
				const rent = f.properties['median'];
				const colors = ["#ffffff", "#ffe0d8", "#ffc0b0", "#ff9e89", "#f97c64", "#ea5d45", "#d63d29", "#bd1d12", "#9d0000"];
				const rank = (rent - minRent) / (maxRent - minRent);
				const index = Math.min(Math.ceil(rank * colors.length), colors.length - 1);
				f.properties.medianText = `€${rent}/m²`;
				f.properties.color = colors[index];
			});

			// Add shapes
			const mapDataSource = map.addSource('plz-data', {
				type: 'geojson',
				data: mapData,
			});
			map.fitBounds(mapDataSource.getBounds(), { padding: 20 });

			// Add labels
			map.addSource('plz-data-labels', {
				type: 'geojson',
				data: {
					type: "FeatureCollection",
					features: mapData.features.map(f => {
						return {
							type: "Feature",
							properties: {
								medianShort: formatCurrency(f.properties.median, includeCents=false, currency=null),
								medianMedium: formatCurrency(f.properties.median, includeCents=false) + '/m²',
								medianLong: formatCurrency(f.properties.median, includeCents=true) + '/m²',
							},
							geometry: {
								type: "Point",
								coordinates: f.properties.center,
							},
						}
					})
				}
			});

			map.addLayer({
				id: 'geojson-labels',
				type: 'symbol',
				source: 'plz-data-labels',
				layout: {
					'text-field': [
						'step',
						['zoom'],
						['get', 'medianShort'],
						11, ['get', 'medianMedium'],
						13, ['get', 'medianLong'],
					],
					"text-size": [
						'step',
						['zoom'],
						11,
						11, 13,
						13, 16,
						14, 24,
					],
				},
				paint: {
					'text-color': '#000',
					'text-halo-color': '#fff',
					'text-halo-width': [
						'step',
						['zoom'],
						1.5,
						14, 2,
					],
				},
			});

			map.addLayer({
				id: 'geojson-fill-top',
				type: 'fill',
				source: 'plz-data',
				paint: {
					'fill-color': ['get', 'color'],  // precomputed
					'fill-opacity': [
						'step',
						['zoom'],
						1,
						5, 0.8,
						11, 0.6,
						14, 0.4,
					],
				}
			}, "Grenzen_Staatsgrenze");

			map.addLayer({
				id: 'geojson-outline',
				type: 'line',
				source: 'plz-data',
				paint: {
					'line-color': '#000a',
					'line-width': [
						'step',
						['zoom'],
						0.5,
						11, 1,
						12, 2,
					],
					'line-opacity': 0.3
				}
			}, "Grenzen_Staatsgrenze");

			// Click to zoom
			map.on('click', 'geojson-fill-top', (e) => {
				// Geographic coordinates of the LineString
				map.fitBounds(getFeatureBounds(e.features[0]), {
					padding: 20
				});
				plzInput.value = e.features[0].id;

				locationElement.innerHTML = e.features[0].id;
				sampleSizeElement.innerHTML = e.features[0].properties.count;
			});
		});

	map.on('mousemove', 'geojson-fill-top', (e) => {
		const feature = e.features[0];
		if (feature !== hoveredFeature) {
			hoveredFeature = feature;

			// Change the cursor style as a UI indicator.
			map.getCanvas().style.cursor = 'pointer';
		}
	});

	map.on('mouseleave', 'geojson-fill-top', () => {
		hoveredFeature = undefined;
		map.getCanvas().style.cursor = '';
	});
});
{% endjs %}