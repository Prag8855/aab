{% extends "_layout.html" %}
{% set metatitle = "Berlin rent prices map" %}
{% set metadescription = "See the rent per m² in each Berlin neighbourood" %}

{% block postHead %}
	<meta name="robots" content="noindex">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css" rel="stylesheet"/>
	<script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>
	<style>
		body, html{
			height: 100%;
		}
		body{
			grid-template-rows: var(--h-header) 1fr auto!important;
		}
		#map {
			color: var(--c-text);
			top:0; bottom:0; width:100%;
			border-radius: var(--b-radius);
			box-shadow: var(--shadow-l);
		}
	</style>
{% endblock %}

{% block main %}
	<main aria-label="Map">
		<div id="map"></div>
	</main>
	<div class="sidebar no-print" data-nosnippet aria-hidden="true">
		<h2>Rent prices in Berlin</h2>
		<p>This map shows the <strong>median rent price per m²</strong>, based on <span id="sampleSize">thousands of</span> apartments listed in the last 12 months.</p>
		<small>Data from <a href="https://www.stekkies.com/en-de/">Stekkies</a>, December 2025</small>
	</div>
{% endblock %}

{% js %}
// Initialize MapLibre
const map = new maplibregl.Map({
	container: 'map',
	// style: 'https://sgx.geodatenzentrum.de/gdz_basemapde_vektor/styles/bm_web_gry.json',
	style: {% include "tools/rent-map/_mapStyle.json" %},
	center: [13.405, 52.52],
	zoom: 10
});

function getFeatureBounds(f){
	return f.geometry.coordinates
		.flat(f.geometry.type === "MultiPolygon" ? 2 : 1)
		.reduce(
			(bounds, coord) => bounds.extend(coord),
			new maplibregl.LngLatBounds()
		)
}

// Add interactive GeoJSON layer
map.on('load', () => {
	let hoveredFeature = undefined;

	maplibregl.addProtocol('custom', async (params, abortController) => {
		const tileRequest = await fetch(params.url.replace('custom://', 'https://'));

		// const [_, __, ___, ____, _____, z, x, yy] = params.url.split('/');
		// const [y, ______] = yy.split('.');
		// console.log(z, x, y);

		if (tileRequest.status == 200) {
			const canvas = document.createElement('canvas');
			canvas.width = 256;
			canvas.height = 256;
			const ctx = canvas.getContext('2d');

			// Convert the image response into a canvas
			const blob = await tileRequest.blob()
			const img = new Image();
			img.src = URL.createObjectURL(blob);
			await img.decode();
			ctx.drawImage(img, 0, 0, 256, 256);
			URL.revokeObjectURL(img.src);

			const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
			const data = imageData.data;

			let minOpacity = 255;
			let maxOpacity = 0;
			for (let i = 0; i < data.length; i += 4) {
				minOpacity = Math.min(minOpacity, data[i+3]); // Low noise, white
				maxOpacity = Math.max(maxOpacity, data[i+3]); // High noise, dark gray
			}

			for (let i = 0; i < data.length; i += 4) {
				// data[i] = 218; // #da513d
				// data[i+1] = 81;
				// data[i+2] = 61;
				data[i+3] = data[i+3] === 207 && data[i] !== 255 ? 255 : 0; // If the pixel is transparent in the original image, ignore it; there is no data.
			}
			
			ctx.putImageData(imageData, 0, 0);
			const newBlob = await new Promise(resolve => canvas.toBlob(resolve));
			return {data: await newBlob.arrayBuffer()};
		} else {
			throw new Error(`Tile fetch error: ${tileRequest.statusText}`);
		}
	});

	map.addSource('noise-map-2022', {
		'type': 'raster',
		'tiles': [
			'custom://gdi.berlin.de/services/wms/ua_stratlaerm_2022?REQUEST=GetMap&SERVICE=WMS&VERSION=1.3.0&FORMAT=image/png&STYLES=&TRANSPARENT=true&LAYERS=bf_gesamtlaerm_den2022&SINGLETILE=true&WIDTH=256&HEIGHT=256&CRS=EPSG:3857&BBOX={bbox-epsg-3857}'
		],
		'tileSize': 256
	}, "Grenzen_Staatsgrenze");

	fetch('/tools/rent-map/data.json')
		.then(r => r.json())
		.then(mapData => {
			// Color calculation
			const rents = mapData.features.map(d => d.properties['median']);
			const minRent = Math.min(...rents);
			const maxRent = Math.max(...rents);
			const sampleSize = mapData.features.reduce((total, f) => total + f.properties.count, 0);
			document.getElementById('sampleSize').innerHTML = Intl.NumberFormat("en-US").format(sampleSize);

			mapData.features.forEach(f => {
				const rent = f.properties['median'];
				const colors = ["#ffffff", "#ffe0d8", "#ffc0b0", "#ff9e89", "#f97c64", "#ea5d45", "#d63d29", "#bd1d12", "#9d0000"];
				const rank = (rent - minRent) / (maxRent - minRent);
				const index = Math.min(Math.ceil(rank * colors.length), colors.length - 1);
				f.properties.medianText = `€${rent}/m²`;
				f.properties.color = colors[index];
			});

			// Add shapes
			const mapDataSource = map.addSource('plz-data', {
				type: 'geojson',
				data: mapData,
			});
			map.fitBounds(mapDataSource.getBounds(), { padding: 20 });

			map.addLayer({
				'id': 'noise-map-2022',
				'type': 'raster',
				'source': 'noise-map-2022',
				'slot': 'middle',
				'paint': {
					'raster-opacity': 0.8
				}
			}, "Grenzen_Staatsgrenze");
	  });

	map.on('mousemove', 'geojson-fill-top', (e) => {
		const feature = e.features[0];
		if (feature !== hoveredFeature) {
			hoveredFeature = feature;

			// Change the cursor style as a UI indicator.
			map.getCanvas().style.cursor = 'pointer';
		}

	});

	map.on('mouseleave', 'geojson-fill-top', () => {
		hoveredFeature = undefined;
		map.getCanvas().style.cursor = '';
	});
});
{% endjs %}