{% extends "tools/_map.html" %}
{% set mapName = "Map of noise pollution in Berlin" %}
{% set mapDescribedBy = "map-description" %}

{% block postHead %}
	{{ super() }}
	{% js %}
		map.on('load', () => {
			let hoveredFeature = undefined;

			maplibregl.addProtocol('custom', async (params, abortController) => {
				const tileRequest = await fetch(params.url.replace('custom://', 'https://'));

				// const [_, __, ___, ____, _____, z, x, yy] = params.url.split('/');
				// const [y, ______] = yy.split('.');
				// console.log(z, x, y);

				if (tileRequest.status == 200) {
					const canvas = document.createElement('canvas');
					canvas.width = 256;
					canvas.height = 256;
					const ctx = canvas.getContext('2d');

					// Convert the image response into a canvas
					const blob = await tileRequest.blob()
					const img = new Image();
					img.src = URL.createObjectURL(blob);
					await img.decode();
					ctx.drawImage(img, 0, 0, 256, 256);
					URL.revokeObjectURL(img.src);

					const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
					const data = imageData.data;

					let minOpacity = 255;
					let maxOpacity = 0;
					for (let i = 0; i < data.length; i += 4) {
						minOpacity = Math.min(minOpacity, data[i+3]); // Low noise, white
						maxOpacity = Math.max(maxOpacity, data[i+3]); // High noise, dark gray
					}

					for (let i = 0; i < data.length; i += 4) {
						// data[i] = 218; // #da513d
						// data[i+1] = 81;
						// data[i+2] = 61;
						data[i+3] = data[i+3] === 207 && data[i] !== 255 ? 255 : 0; // If the pixel is transparent in the original image, ignore it; there is no data.
					}
					
					ctx.putImageData(imageData, 0, 0);
					const newBlob = await new Promise(resolve => canvas.toBlob(resolve));
					return {data: await newBlob.arrayBuffer()};
				} else {
					throw new Error(`Tile fetch error: ${tileRequest.statusText}`);
				}
			});

			map.addSource('noise-map-2022', {
				'type': 'raster',
				'tiles': [
					'custom://gdi.berlin.de/services/wms/ua_stratlaerm_2022?REQUEST=GetMap&SERVICE=WMS&VERSION=1.3.0&FORMAT=image/png&STYLES=&TRANSPARENT=true&LAYERS=bf_gesamtlaerm_den2022&SINGLETILE=true&WIDTH=256&HEIGHT=256&CRS=EPSG:3857&BBOX={bbox-epsg-3857}'
				],
				'tileSize': 256
			}, "Grenzen_Staatsgrenze");

			map.addLayer({
				'id': 'noise-map-2022',
				'type': 'raster',
				'source': 'noise-map-2022',
				'slot': 'middle',
				'paint': {
					'raster-opacity': 0.8
				}
			}, "Grenzen_Staatsgrenze");
		});
	{% endjs %}
{% endblock %}

{% block extraScss %}
	{{ super() }}
	#map-description{
		@include box;
		@include text-block;

		display: grid;
		overflow: hidden;
		grid-template-columns: var(--xxl) 1fr;
		gap: 0 var(--s);
		width: 100%;
		max-width: var(--w-sidebar);
		padding-right: var(--m);
		box-sizing: border-box;

		dt{
			white-space: nowrap;
			width: var(--xxl);
			overflow: hidden;
			color: transparent;
		}
	}
{% endblock %}

{% block sidebar %}
	<h2>Noise pollution in Berlin</h2>
	<dl id="map-description" aria-label="Color legend">
		<dt style="background:#f9f9f9">White</dt>
		<dd>Less than 55 dB</dd>

		<dt style="background:#e2f2bf">Light green</dt>
		<dd>55 to 59 dB</dd>

		<dt style="background:#f3c683">Yellow</dt>
		<dd>60 to 64 dB</dd>

		<dt style="background:#cd463e">Red</dt>
		<dd>65 to 69 dB</dd>

		<dt style="background:#75085c">Purple</dt>
		<dd>70 to 74 dB</dd>

		<dt style="background:#430a4a">Dark purple</dt>
		<dd>Over 75 dB</dd>
	</dl>
	<small>Data from <a href="https://www.berlin.de/umweltatlas/en/traffic-noise/noise-pollution/2022/maps/artikel.1327919.en.php">Berlin.de</a> (2022). {{ attribution }}</small>
{% endblock %}